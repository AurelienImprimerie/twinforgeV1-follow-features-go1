# TwinForge â€” Time Forge Project Structure

**Version:** 1.0 â€¢ **Status:** Functional â€¢ **Last Update:** January 2025

Complete documentation of the file and folder organization for the **Time Forge** (intermittent fasting system) of TwinForge.

---

## ğŸ“‹ Table of Contents

- [Time Forge Overview](#time-forge-overview)
- [Feature Architecture](#feature-architecture)
- [Page Structure](#page-structure)
- [Components by Category](#components-by-category)
- [Hooks and Business Logic](#hooks-and-business-logic)
- [Utilities and Helpers](#utilities-and-helpers)
- [Edge Functions](#edge-functions)
- [Profile Integration](#profile-integration)
- [Configuration Files](#configuration-files)
- [Database](#database)

---

## ğŸ¯ Time Forge Overview

The **Time Forge** is TwinForge's intermittent fasting system, allowing users to start, track, and analyze their fasting sessions through a complete intelligent pipeline with personalized AI analyses.

### Objectives
- **Real-time tracking** of fasting sessions with precise timer
- **Automatic detection** of metabolic phases
- **Personalized AI analyses** generated by GPT-5 Mini
- **Rich visualizations** (heatmaps, charts, trends)
- **Intelligent cache** for cost optimization

---

## ğŸ—ï¸ Feature Architecture

### Tech Stack
- **Frontend:** React 18 + TypeScript + Framer Motion
- **State Management:** Zustand (persistent pipeline) + React Query (network cache)
- **Backend:** Supabase Edge Functions (Deno)
- **Spatial Forge:** OpenAI GPT-5 Mini for analyses and recommendations
- **Timer System:** JavaScript intervals with performance optimizations
- **Database:** PostgreSQL with RLS and automatic triggers

### Data Flow
```
User (Start/Stop Fasting)
    â†“
Frontend (Zustand Pipeline + Real-time Timer)
    â†“
Database (fasting_sessions table)
    â†“
Edge Function: fasting-insights-generator (GPT-5 Mini + Cache)
    â†“
Edge Function: fasting-progression-analyzer (GPT-5 Mini + Metrics)
    â†“
Frontend (Visualizations + AI Advice)
```

---

## ğŸ“ Page Structure

### Main Page
```
src/app/pages/
â”œâ”€ FastingPage.tsx              # Main page with 4 tabs (Daily, Insights, Progression, History)
â””â”€ Fasting/
   â””â”€ FastingInputPage.tsx      # Pipeline for start/stop sessions (Setup â†’ Active â†’ Completion)
```

---

## ğŸ§© Components by Category

### ğŸ“ Complete Component Structure
```
src/app/pages/Fasting/
â”œâ”€ components/
â”‚  â”œâ”€ index.ts                  # Centralized export
â”‚  â”œâ”€ Tabs/
â”‚  â”‚  â”œâ”€ FastingDailyTab.tsx    # Today: current status & daily summary
â”‚  â”‚  â”œâ”€ FastingInsightsTab.tsx # Insights: AI pattern analysis
â”‚  â”‚  â”œâ”€ FastingProgressionTab.tsx # Progression: metrics & trends
â”‚  â”‚  â””â”€ FastingHistoryTab.tsx  # History: complete sessions
â”‚  â”œâ”€ Stages/
â”‚  â”‚  â”œâ”€ FastingSetupStage.tsx  # Protocol configuration
â”‚  â”‚  â”œâ”€ FastingActiveStage.tsx # Real-time tracking
â”‚  â”‚  â””â”€ FastingCompletionStage.tsx # Session finalization
â”‚  â”œâ”€ Cards/
â”‚  â”‚  â”œâ”€ DynamicFastingCTA.tsx  # Adaptive call-to-action
â”‚  â”‚  â”œâ”€ FastingCurrentSessionCard.tsx # Active session details
â”‚  â”‚  â”œâ”€ FastingDailySummaryCard.tsx # Daily summary
â”‚  â”‚  â”œâ”€ FastingMetabolicPhasesCard.tsx # Metabolic phases
â”‚  â”‚  â”œâ”€ FastingProtocolInfoCard.tsx # Protocol information
â”‚  â”‚  â”œâ”€ FastingTipsCard.tsx    # Fasting tips
â”‚  â”‚  â”œâ”€ FastingAchievementsCard.tsx # Achievements
â”‚  â”‚  â””â”€ FastingSessionSummaryCard.tsx # Session summary
â”‚  â”œâ”€ Shared/
â”‚  â”‚  â”œâ”€ FastingProgressHeader.tsx # Progress header
â”‚  â”‚  â”œâ”€ FastingPeriodSelector.tsx # Period selector
â”‚  â”‚  â””â”€ FastingDataCompletenessAlert.tsx # Data alerts
â”‚  â”œâ”€ Insights/
â”‚  â”‚  â”œâ”€ FastingInsightsLoadingSkeleton.tsx # AI loading animation
â”‚  â”‚  â”œâ”€ FastingInsightsSummaryCard.tsx # AI insights summary
â”‚  â”‚  â””â”€ FastingInsightCard.tsx # Individual insight cards
â”‚  â”œâ”€ Progression/
â”‚  â”‚  â”œâ”€ FastingProgressionLoadingSkeleton.tsx # Progression loading
â”‚  â”‚  â”œâ”€ FastingProgressionSummaryCard.tsx # Progression metrics
â”‚  â”‚  â”œâ”€ FastingConsistencyChart.tsx # Consistency chart
â”‚  â”‚  â”œâ”€ FastingDurationTrendChart.tsx # Duration trends
â”‚  â”‚  â””â”€ FastingHeatmap.tsx     # GitHub-style heatmap
â”‚  â””â”€ History/
â”‚     â”œâ”€ FastingHistoryFilters.tsx # Filter interface
â”‚     â”œâ”€ FastingHistoryStatsCard.tsx # Global statistics
â”‚     â”œâ”€ FastingSessionCard.tsx # Session cards
â”‚     â””â”€ FastingHistoryLoadingSkeleton.tsx # History loading
â”œâ”€ hooks/
â”‚  â”œâ”€ useFastingPipeline.ts     # Pipeline state management
â”‚  â”œâ”€ useFastingInsightsGenerator.ts # AI insight generation
â”‚  â”œâ”€ useFastingProgressionData.ts # Progression data with AI
â”‚  â”œâ”€ useFastingHistory.ts      # History management
â”‚  â””â”€ useTodayFastingSessions.ts # Today's sessions
â”œâ”€ utils/
â”‚  â””â”€ fastingUtils.ts           # Utilities (formatting, calculations)
â””â”€ FastingInputPage.tsx         # Main pipeline page
```

### ğŸ“ Category Descriptions

**Tabs:** Main tabs of FastingPage
- `FastingDailyTab`: Current status and today's sessions
- `FastingInsightsTab`: AI analysis of fasting patterns
- `FastingProgressionTab`: Progression metrics and trends
- `FastingHistoryTab`: Complete history with filters

**Stages:** FastingInputPage pipeline steps
- `FastingSetupStage`: Fasting protocol configuration
- `FastingActiveStage`: Real-time tracking of active session
- `FastingCompletionStage`: Finalization and save

**Cards:** Reusable content components
- `DynamicFastingCTA`: Adaptive call-to-action based on state
- `FastingCurrentSessionCard`: Active session details with metabolic phases
- `FastingDailySummaryCard`: Today's session summary
- `FastingMetabolicPhasesCard`: Real-time metabolic phases
- `FastingProtocolInfoCard`: Protocol information
- `FastingTipsCard`: Practical fasting tips
- `FastingAchievementsCard`: Achievements and encouragements
- `FastingSessionSummaryCard`: Detailed session summary

**Shared:** Components shared between tabs
- `FastingProgressHeader`: Real-time progress header
- `FastingPeriodSelector`: Analysis period selector
- `FastingDataCompletenessAlert`: Missing data alerts

**Insights:** AI analysis specific components
- `FastingInsightsLoadingSkeleton`: AI loading animation
- `FastingInsightsSummaryCard`: Narrative summary with global score
- `FastingInsightCard`: Individual insights with actions

**Progression:** Trend visualization components
- `FastingProgressionLoadingSkeleton`: Progression analysis loading
- `FastingProgressionSummaryCard`: Metrics with AI narrative analysis
- `FastingConsistencyChart`: Consistency chart
- `FastingDurationTrendChart`: Duration evolution
- `FastingHeatmap`: GitHub-style activity calendar

**History:** History management components
- `FastingHistoryFilters`: Advanced filtering interface
- `FastingHistoryStatsCard`: Global statistics
- `FastingSessionCard`: Individual session cards
- `FastingHistoryLoadingSkeleton`: History loading animation

---

## ğŸ£ Hooks and Business Logic

### ğŸ“ Specialized Hooks
```
src/app/pages/Fasting/hooks/
â”œâ”€ useFastingPipeline.ts        # Pipeline state management (persistent Zustand)
â”œâ”€ useFastingInsightsGenerator.ts # AI insight generation with cache
â”œâ”€ useFastingProgressionData.ts # Progression data with AI
â”œâ”€ useFastingHistory.ts         # History management with filters
â””â”€ useTodayFastingSessions.ts   # Today's sessions in real-time
```

### ğŸ“ Hook Responsibilities

**`useFastingPipeline`** - Feature core
- **Persistent state**: Survives reloads (Zustand + localStorage)
- **Global timer**: Real-time updates every second
- **Actions**: `startFasting()`, `stopFasting()`, `saveFastingSession()`
- **Dynamic selectors**: `useFastingElapsedSeconds()`, `useFastingProgressPercentage()`

**`useFastingInsightsGenerator`** - AI pattern analysis
- **Intelligent cache**: Avoids redundant AI calls (24h)
- **Adaptive thresholds**: 3/8/20 sessions depending on period
- **Graceful fallback**: Encouragement messages if insufficient data
- **Navigation protection**: Blocks exit during AI generation

**`useFastingProgressionData`** - Metrics and trends
- **Local calculations**: Basic metrics always available
- **Conditional AI**: Narrative analysis if sufficient data
- **Visualizations**: Data for heatmap, charts, trends
- **Server cache**: Cost optimization with deduplication

**`useFastingHistory`** - History management
- **Advanced filtering**: Status, protocol, duration, dates
- **Global statistics**: Calculations on all sessions
- **Secure deletion**: RLS + user confirmation
- **Pagination**: Support for large data volumes

**`useTodayFastingSessions`** - Daily sessions
- **Real-time**: Automatic refetch every minute
- **Daily statistics**: Total fasted, sessions, averages
- **Consistency**: Daily performance evaluation
- **Motivational messages**: Personalized encouragements

---

## ğŸ› ï¸ Utilities and Helpers

### ğŸ“ Time Forge Utilities
```
src/app/pages/Fasting/utils/
â””â”€ fastingUtils.ts              # Utilities (formatting, calculations, outcomes)

src/lib/nutrition/
â”œâ”€ fastingPhases.ts             # Metabolic phase definitions
â”œâ”€ fastingProtocols.ts          # Fasting protocols (16:8, 18:6, etc.)
â””â”€ proteinCalculator.ts         # Protein target calculations

src/system/data/
â””â”€ mockFastingSessions.ts       # Test data generation
```

### ğŸ“ Key Utility Functions

**`fastingUtils.ts`** - Formatting and calculations
- `formatElapsedTime()`: Seconds â†’ "16h 45m 30s" conversion
- `calculateFastingProgress()`: Progress percentage
- `determineSessionOutcome()`: success/partial/missed classification
- `getOutcomeTheme()`: Colors and content based on outcome

**`fastingPhases.ts`** - Metabolic phases
- `getCurrentFastingPhase()`: Current phase based on elapsed time
- `getPhaseProgress()`: Progress within current phase
- `getNextFastingPhase()`: Next phase to reach
- `estimateCaloriesBurnedInPhase()`: Calorie estimation by phase and weight
- `getMotivationalMessage()`: Contextual encouragement messages

**`fastingProtocols.ts`** - Predefined protocols
- `getProtocolById()`: Protocol retrieval by ID
- `suggestFastingTimes()`: Suggested times by chronotype
- `calculateCustomFastingWindow()`: Custom window calculation
- `validateFastingWindow()`: Time consistency validation

**`mockFastingSessions.ts`** - Test data
- `generateMockSessions()`: Realistic session generation
- `createMockFastingSessions()`: Database insertion for tests
- `clearMockFastingSessions()`: Test data cleanup

---

## âš¡ Edge Functions

### ğŸ“ Serverless Functions
```
supabase/functions/
â”œâ”€ fasting-insights-generator/  # Agent 1: Pattern analysis
â”‚  â””â”€ index.ts                  # GPT-5 Mini + Intelligent cache
â””â”€ fasting-progression-analyzer/ # Agent 2: Progression analysis
   â””â”€ index.ts                  # GPT-5 Mini + Advanced metrics
```

### ğŸ“ Edge Function Specialties

**`fasting-insights-generator`** - Pattern detection
- **Model**: GPT-5 Mini optimized for behavioral analysis
- **Specialties**: Temporal patterns, actionable recommendations
- **Cache**: 24h with SHA256 key of input data
- **Average cost**: ~$0.00076 USD (2659 tokens)
- **Duration**: ~15-45 seconds

**`fasting-progression-analyzer`** - Narrative analysis
- **Model**: GPT-5 Mini optimized for temporal data analysis
- **Specialties**: Trends, strategic recommendations, coaching
- **Cache**: 24h with advanced deduplication
- **Average cost**: ~$0.00076 USD (2683 tokens)
- **Duration**: ~20-60 seconds

---

## ğŸ‘¤ Profile Integration

### ğŸ“ Integration Files
```
src/app/pages/Profile/ProfileNutritionTab.tsx # Fasting configuration in profile
src/system/store/userStore.ts                 # Profile data synchronization
```

### ğŸ“ Profile Fields Used

**Critical Fields (Required for AI):**
- `weight_kg`: Calorie calculation burned per metabolic phase
- `height_cm`: BMR calculations and metabolic adjustments
- `objective`: Advice adaptation (fat_loss, muscle_gain, recomp)
- `activity_level`: Recommendation personalization

**Fasting Configuration:**
- `nutrition.fastingWindow.protocol`: Preferred protocol (16:8, 18:6, etc.)
- `nutrition.fastingWindow.start`: Usual start time
- `nutrition.fastingWindow.end`: Usual end time
- `nutrition.fastingWindow.windowHours`: Custom duration
- `nutrition.fastingWindow.mealsPerDay`: Number of meals in window

**Optimizing Fields:**
- `emotions.chronotype`: Optimal time suggestions
- `emotions.stress`: Adaptation according to stress level
- `emotions.sleepHours`: Correlation with performance

---

## âš™ï¸ Configuration Files

### ğŸ“ Specific Configuration
```
src/config/featureFlags.ts     # Feature flags for testing and development
```

### ğŸ“ Available Feature Flags
- `MOCK_FASTING_DATA`: Test data generation
- `BYPASS_MIN_DATA_FOR_AI`: AI threshold bypass (development)
- `FASTING_CACHE_DURATION`: Cache duration (default 24h)

---

## ğŸ¨ Styles and Animations

### ğŸ“ Time Forge Specific Styles
```
src/styles/
â”œâ”€ components/
â”‚  â””â”€ celebration-animations.css # Success celebration animations
â”œâ”€ glassV2/
â”‚  â””â”€ animations.css            # Breathing, pulse, and timer animations
â””â”€ effects/
   â””â”€ motion.css                # Spatial icon animations and transitions
```

### ğŸ“ Fasting-Specific Animations
- **Breathing icons**: For active session indicators
- **Progress animations**: Smooth progress bar updates
- **Celebration effects**: Success completion animations
- **Timer pulsing**: Visual feedback for active sessions
- **Phase transitions**: Smooth metabolic phase changes

---

## ğŸ—„ï¸ Database

### ğŸ“ Main Tables
```
fasting_sessions                # User fasting sessions
â”œâ”€ id (uuid, PK)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ start_time (timestamptz)
â”œâ”€ end_time (timestamptz, nullable)
â”œâ”€ target_hours (integer)
â”œâ”€ actual_duration_hours (numeric, nullable)
â”œâ”€ protocol_id (text, nullable)
â”œâ”€ status (text: active|completed|cancelled)
â”œâ”€ notes (text, nullable)
â””â”€ created_at (timestamptz)

ai_analysis_jobs                # AI analysis cache
â”œâ”€ id (uuid, PK)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ analysis_type (enum: fasting_insights|fasting_progression)
â”œâ”€ status (enum: pending|processing|completed|failed)
â”œâ”€ input_hash (text) # Deduplication key
â”œâ”€ request_payload (jsonb)
â”œâ”€ result_payload (jsonb)
â””â”€ created_at (timestamptz)
```

### ğŸ“ Security and Performance
- **RLS enabled** on all tables
- **Optimized indexes** for queries by user_id and timestamp
- **Automatic triggers** for updated_at
- **Validation constraints** on durations and statuses

---

*This documentation is specific to the Time Forge. Consult other STRUCTURE_*.md files for other features. Last revision: January 2025*