# Detailed Documentation: The Time Forge (Intermittent Fasting)

**Version:** 1.0 ‚Ä¢ **Status:** Functional and production-ready ‚Ä¢ **Last Update:** January 2025

The Time Forge is TwinForge's intermittent fasting system, allowing users to start, track, and analyze their fasting sessions through a complete intelligent pipeline with personalized AI analyses.

---

## üìã Table of Contents

- [Overview](#overview)
- [Technical Architecture](#technical-architecture)
- [Detailed User Pipeline](#detailed-user-pipeline)
- [Time Forge Tabs](#time-forge-tabs)
- [User Profile Integration](#user-profile-integration)
- [Spatial Forge Generated Data](#spatial-forge-generated-data)
- [TypeScript Contracts](#typescript-contracts)
- [Detailed Edge Functions](#detailed-edge-functions)
- [Optimizations and Performance](#optimizations-and-performance)
- [Costs and Governance](#costs-and-governance)
- [Observability and Debugging](#observability-and-debugging)
- [Future Integration with Central Brain](#future-integration-with-central-brain)

---

## üéØ Overview

### Objective
Enable users to practice intermittent fasting with real-time tracking, automatic metabolic phase detection, and personalized AI analyses to optimize their temporal discipline and metabolic benefits.

### Added Value
- **Real-time tracking:** Active sessions with precise timer and metabolic phases
- **Configurable protocols:** 16:8, 18:6, 20:4, OMAD, or custom
- **Advanced AI analyses:** Personalized insights generated by GPT-5 Mini
- **Intelligent cache:** Cost optimization with analysis caching
- **Rich visualizations:** Heatmaps, consistency charts, temporal trends
- **Metabolic guidance:** Fasting phases with real-time benefits and advice

### Role in TwinForge Ecosystem
The Time Forge generates temporal and metabolic data that will feed the future "Central Brain" for holistic advice combining fasting, nutrition, activity, and morphology.

---

## üèóÔ∏è Technical Architecture

### Tech Stack
- **Frontend:** React 18 + TypeScript + Framer Motion
- **State Management:** Zustand (persistent pipeline) + React Query (network cache)
- **Backend:** Supabase Edge Functions (Deno)
- **Spatial Forge:** OpenAI GPT-5 Mini for analyses and recommendations
- **Timer System:** JavaScript intervals with performance optimizations
- **Database:** PostgreSQL with RLS and automatic triggers

### Data Flow
```
User (Start/Stop Fasting)
    ‚Üì
Frontend (Zustand Pipeline + Real-time Timer)
    ‚Üì
Database (fasting_sessions table)
    ‚Üì
Edge Function: fasting-insights-generator (GPT-5 Mini + Cache)
    ‚Üì
Edge Function: fasting-progression-analyzer (GPT-5 Mini + Metrics)
    ‚Üì
Frontend (Visualizations + AI Advice)
```

### Pipeline Architecture
```
FastingPipeline (Zustand Store)
‚îú‚îÄ Setup Stage (Protocol configuration)
‚îú‚îÄ Active Stage (Real-time tracking + phases)
‚îú‚îÄ Completion Stage (Finalization + save)
‚îî‚îÄ Persistent State (Survives reloads)
```

---

## üîÑ Detailed User Pipeline

### 1. Fasting Configuration (`FastingSetupStage`)

**Objective:** Allow user to configure their fasting protocol and start their session.

**Frontend Components:**
- `src/app/pages/Fasting/components/Stages/FastingSetupStage.tsx` (Main interface)
- `src/app/pages/Fasting/components/Cards/FastingProtocolInfoCard.tsx` (Protocol information)
- `src/app/pages/Fasting/components/Cards/FastingTipsCard.tsx` (Fasting tips)

**Data Collected:**
- **Protocol:** Selection from 16:8, 18:6, 20:4, OMAD or custom
- **Target duration:** Number of fasting hours desired
- **Start time:** Session start timestamp
- **Metadata:** `userId`, `clientScanId`, timestamp

**Validations:**
- **Duration:** Between 8h and 48h maximum
- **Protocol:** Validation of predefined protocols
- **Active session:** Check that no session is already in progress

### 2. Active Session (`FastingActiveStage`)

**Objective:** Track fasting session in real-time with metabolic phase detection.

**Frontend Components:**
- `src/app/pages/Fasting/components/Stages/FastingActiveStage.tsx` (Main interface)
- `src/app/pages/Fasting/components/Cards/FastingCurrentSessionCard.tsx` (Session details)
- `src/app/pages/Fasting/components/Cards/FastingMetabolicPhasesCard.tsx` (Metabolic phases)
- `src/app/pages/Fasting/components/Shared/FastingProgressHeader.tsx` (Progress header)

**Real-time Logic:**
- **Global timer:** JavaScript interval every second
- **Dynamic calculations:** Elapsed time, progress, current metabolic phase
- **Metabolic phases:** Fed State ‚Üí Early Fasting ‚Üí Fat Burning ‚Üí Autophagy ‚Üí Deep Autophagy
- **Calorie estimates:** Based on current phase and user weight

**Calculated Data:**
```typescript
// Real-time elapsed time
const elapsedSeconds = useFastingElapsedSeconds();
const elapsedHours = elapsedSeconds / 3600;

// Progress towards goal
const progressPercentage = useFastingProgressPercentage();

// Current metabolic phase
const currentPhase = getCurrentFastingPhase(elapsedHours);
const phaseProgress = getPhaseProgress(elapsedHours, currentPhase);

// Estimated calories burned
const estimatedCalories = estimateCaloriesBurnedInPhase(currentPhase, elapsedHours, userWeight);
```

### 3. Session Finalization (`FastingCompletionStage`)

**Objective:** Finalize session, determine outcome and save data.

**Frontend Components:**
- `src/app/pages/Fasting/components/Stages/FastingCompletionStage.tsx` (Main interface)
- `src/app/pages/Fasting/components/Cards/FastingSessionSummaryCard.tsx` (Detailed summary)
- `src/app/pages/Fasting/components/Cards/FastingAchievementsCard.tsx` (Achievements)

**Outcome Determination Logic:**
```typescript
function determineSessionOutcome(actualDurationHours: number, targetHours: number) {
  const completionPercentage = (actualDurationHours / targetHours) * 100;
  
  if (completionPercentage >= 90) return 'success';    // 90%+ = Success
  if (completionPercentage >= 50) return 'partial';    // 50-89% = Partial
  return 'missed';                                     // <50% = Missed
}
```

**Save:**
- **Table:** `fasting_sessions` with RLS
- **Cache invalidation:** React Query for real-time updates
- **Audit:** Detailed logs of completed session

---

## üìä Time Forge Tabs

### üåÖ Today (`FastingDailyTab`)

**Objective:** Display current fasting status and today's sessions.

**File:** `src/app/pages/Fasting/components/Tabs/FastingDailyTab.tsx`

**Key Components:**
- `DynamicFastingCTA`: Adaptive call-to-action based on state (no session, active session, completed session)
- `FastingCurrentSessionCard`: Active session details with metabolic phases
- `FastingDailySummaryCard`: Summary of today's completed sessions
- `FastingTipsCard`: Practical tips to optimize fasting

**Hooks Used:**
- `useFastingPipeline()`: Pipeline state (setup, active, completion)
- `useFastingElapsedSeconds()`: Real-time elapsed time
- `useFastingProgressPercentage()`: Progress towards goal
- `useTodayFastingSessions()`: Today's completed sessions

**Data Logic:**
- **Source:** `fasting_sessions` table filtered by `user_id` and today's date
- **Real-time calculations:** Elapsed time, progress, metabolic phase
- **Daily statistics:** Total fasted, number of sessions, average duration, today's record

### üí° Insights (`FastingInsightsTab`)

**Objective:** Present personalized AI analyses of fasting patterns.

**File:** `src/app/pages/Fasting/components/Tabs/FastingInsightsTab.tsx`

**Key Components:**
- `FastingPeriodSelector`: Analysis period selection (7d, 30d, 90d)
- `FastingDataCompletenessAlert`: Alert if insufficient data for AI
- `FastingInsightsSummaryCard`: Narrative summary with global score
- `FastingInsightCard`: Individual insights with actionable actions
- `FastingInsightsLoadingSkeleton`: AI loading animation

**Hooks Used:**
- `useFastingInsightsGenerator(period)`: Insight generation with cache
- `useFastingHistory(filters)`: History for data verification

**Adaptive AI Thresholds:**
- **7 days:** Minimum 3 completed sessions
- **30 days:** Minimum 8 completed sessions
- **90 days:** Minimum 20 completed sessions

**Generated Insight Types:**
- **Pattern:** Habit observations (e.g., "You fast better on weekends")
- **Recommendation:** Actionable advice (e.g., "Adjust your window according to your chronotype")
- **Achievement:** Strengths (e.g., "Excellent consistency this week")
- **Warning:** Alerts (e.g., "Too variable durations, stabilize your schedule")

### üìà Progression (`FastingProgressionTab`)

**Objective:** Analyze fasting performance evolution with advanced metrics.

**File:** `src/app/pages/Fasting/components/Tabs/FastingProgressionTab.tsx`

**Key Components:**
- `FastingPeriodSelector`: Period selection with specific thresholds
- `FastingProgressionSummaryCard`: Global metrics with AI analysis
- `FastingConsistencyChart`: Daily consistency chart
- `FastingDurationTrendChart`: Average duration evolution
- `FastingHeatmap`: GitHub-style visual calendar

**Hooks Used:**
- `useFastingProgressionData(period)`: Complete data with AI
- `useBlocker()`: Protection against navigation during AI generation

**AI Analysis Thresholds:**
- **7 days:** Minimum 5 sessions (stricter than Insights)
- **30 days:** Minimum 12 sessions
- **90 days:** Minimum 20 sessions

**Calculated Metrics:**
```typescript
interface FastingProgressionMetrics {
  totalSessions: number;          // Total sessions
  totalFastedHours: number;       // Total fasted time
  averageDuration: number;        // Average duration per session
  longestFast: number;           // Personal record
  bestStreak: number;            // Best consecutive days streak
  currentStreak: number;         // Current streak
  successRate: number;           // Percentage of successful sessions (‚â•90% goal)
  consistencyScore: number;      // Consistency score (0-100)
}
```

### üìö History (`FastingHistoryTab`)

**Objective:** Browse complete session history with advanced filters.

**File:** `src/app/pages/Fasting/components/Tabs/FastingHistoryTab.tsx`

**Key Components:**
- `FastingHistoryFilters`: Filters by status, protocol, duration, dates
- `FastingHistoryStatsCard`: Global history statistics
- `FastingSessionCard`: Individual session cards with deletion
- `FastingHistoryLoadingSkeleton`: Loading animation

**Hooks Used:**
- `useFastingHistory(limit, filters)`: History with filters
- `useDeleteFastingSession()`: Session deletion
- `useFastingProtocolsFromHistory()`: Used protocols for filters

**Filtering Features:**
- **Status:** All, completed, cancelled
- **Protocol:** Filter by protocol type used
- **Duration:** Min/max duration range
- **Dates:** Custom period with date picker

**Global Statistics:**
```typescript
interface FastingHistoryStats {
  totalSessions: number;          // Total sessions
  completedSessions: number;      // Completed sessions
  cancelledSessions: number;      // Cancelled sessions
  totalHours: number;            // Total fasted time
  averageDuration: number;       // Average duration
  longestSession: number;        // Longest session
  shortestSession: number;       // Shortest session
  mostUsedProtocol: string;      // Most used protocol
  firstSessionDate: string;      // First session date
  lastSessionDate: string;       // Last session date
}
```

---

## üé£ Hooks and Business Logic

### üìÅ Specialized Hooks
```
src/app/pages/Fasting/hooks/
‚îú‚îÄ useFastingPipeline.ts        # Pipeline state management (persistent Zustand)
‚îú‚îÄ useFastingInsightsGenerator.ts # AI insight generation with cache
‚îú‚îÄ useFastingProgressionData.ts # Progression data with AI
‚îú‚îÄ useFastingHistory.ts         # History management with filters
‚îî‚îÄ useTodayFastingSessions.ts   # Today's sessions in real-time
```

### üìù Hook Responsibilities

**`useFastingPipeline`** - Feature core
- **Persistent state**: Survives reloads (Zustand + localStorage)
- **Global timer**: Real-time updates every second
- **Actions**: `startFasting()`, `stopFasting()`, `saveFastingSession()`
- **Dynamic selectors**: `useFastingElapsedSeconds()`, `useFastingProgressPercentage()`

**`useFastingInsightsGenerator`** - AI pattern analysis
- **Intelligent cache**: Avoids redundant AI calls (24h)
- **Adaptive thresholds**: 3/8/20 sessions depending on period
- **Graceful fallback**: Encouragement messages if insufficient data
- **Navigation protection**: Blocks exit during AI generation

**`useFastingProgressionData`** - Metrics and trends
- **Local calculations**: Basic metrics always available
- **Conditional AI**: Narrative analysis if sufficient data
- **Visualizations**: Data for heatmap, charts, trends
- **Server cache**: Cost optimization with deduplication

**`useFastingHistory`** - History management
- **Advanced filtering**: Status, protocol, duration, dates
- **Global statistics**: Calculations on all sessions
- **Secure deletion**: RLS + user confirmation
- **Pagination**: Support for large data volumes

**`useTodayFastingSessions`** - Daily sessions
- **Real-time**: Automatic refetch every minute
- **Daily statistics**: Total fasted, sessions, averages
- **Consistency**: Daily performance evaluation
- **Motivational messages**: Personalized encouragements

---

## üõ†Ô∏è Utilities and Helpers

### üìÅ Time Forge Utilities
```
src/app/pages/Fasting/utils/
‚îî‚îÄ fastingUtils.ts              # Utilities (formatting, calculations, outcomes)

src/lib/nutrition/
‚îú‚îÄ fastingPhases.ts             # Metabolic phase definitions
‚îú‚îÄ fastingProtocols.ts          # Fasting protocols (16:8, 18:6, etc.)
‚îî‚îÄ proteinCalculator.ts         # Protein target calculations

src/system/data/
‚îî‚îÄ mockFastingSessions.ts       # Test data generation
```

### üìù Key Utility Functions

**`fastingUtils.ts`** - Formatting and calculations
- `formatElapsedTime()`: Seconds ‚Üí "16h 45m 30s" conversion
- `calculateFastingProgress()`: Progress percentage
- `determineSessionOutcome()`: success/partial/missed classification
- `getOutcomeTheme()`: Colors and content based on outcome

**`fastingPhases.ts`** - Metabolic phases
- `getCurrentFastingPhase()`: Current phase based on elapsed time
- `getPhaseProgress()`: Progress within current phase
- `getNextFastingPhase()`: Next phase to reach
- `estimateCaloriesBurnedInPhase()`: Calorie estimation by phase and weight
- `getMotivationalMessage()`: Contextual encouragement messages

**`fastingProtocols.ts`** - Predefined protocols
- `getProtocolById()`: Protocol retrieval by ID
- `suggestFastingTimes()`: Suggested times by chronotype
- `calculateCustomFastingWindow()`: Custom window calculation
- `validateFastingWindow()`: Time consistency validation

**`mockFastingSessions.ts`** - Test data
- `generateMockSessions()`: Realistic session generation
- `createMockFastingSessions()`: Database insertion for tests
- `clearMockFastingSessions()`: Test data cleanup

---

## ‚ö° Edge Functions

### üìÅ Serverless Functions
```
supabase/functions/
‚îú‚îÄ fasting-insights-generator/  # Agent 1: Pattern analysis
‚îÇ  ‚îî‚îÄ index.ts                  # GPT-5 Mini + Intelligent cache
‚îî‚îÄ fasting-progression-analyzer/ # Agent 2: Progression analysis
   ‚îî‚îÄ index.ts                  # GPT-5 Mini + Advanced metrics
```

### üìù Edge Function Specialties

**`fasting-insights-generator`** - Pattern detection
- **Model**: GPT-5 Mini optimized for behavioral analysis
- **Specialties**: Temporal patterns, actionable recommendations
- **Cache**: 24h with SHA256 key of input data
- **Average cost**: ~$0.00076 USD (2659 tokens)
- **Duration**: ~15-45 seconds

**`fasting-progression-analyzer`** - Narrative analysis
- **Model**: GPT-5 Mini optimized for temporal data analysis
- **Specialties**: Trends, strategic recommendations, coaching
- **Cache**: 24h with advanced deduplication
- **Average cost**: ~$0.00076 USD (2683 tokens)
- **Duration**: ~20-60 seconds

---

## üîó User Profile Integration

### Configuration in ProfileNutritionTab

**"Goals & Fasting" Section:**
- **Fasting protocol**: Selector with predefined protocols + custom
- **Custom window**: Configurable start/end times
- **Number of meals**: Meal configuration within eating window
- **Protein target**: Automatic calculation based on weight/goal

**Automatic Synchronization:**
```typescript
// Predefined protocol selection
const protocol = getProtocolById('16:8');
setValue('fastingWindow.windowHours', protocol.windowHours);

// Time suggestions by chronotype
const chronotype = profile?.emotions?.chronotype;
const suggestedTimes = suggestFastingTimes(protocol, chronotype);
setValue('fastingWindow.start', suggestedTimes.start);
setValue('fastingWindow.end', suggestedTimes.end);
```

### Impact on AI Analyses

**Profile Data Used by AI:**
```typescript
// Prompt sent to GPT-5 Mini
const profileData = {
  sex: profile.sex,
  weight_kg: profile.weight_kg,
  height_cm: profile.height_cm,
  objective: profile.objective,
  activity_level: profile.activity_level,
  chronotype: profile.emotions?.chronotype,
  stress: profile.emotions?.stress,
  sleepHours: profile.emotions?.sleepHours,
  diet: profile.nutrition?.diet,
  fastingProtocol: profile.nutrition?.fastingWindow?.protocol
};
```

---

## ü§ñ Spatial Forge Generated Data

### Insights Data (`fasting-insights-generator`)

**Response Structure:**
```typescript
interface FastingInsightsResponse {
  summary: {
    overallScore: number;         // Global score (0-100)
    keyFindings: string[];        // Main discoveries
    mainRecommendation: string;   // Main recommendation
    sentiment: 'positive' | 'neutral' | 'encouraging';
  };
  insights: Array<{
    id: string;                   // Unique identifier
    type: 'pattern' | 'recommendation' | 'achievement' | 'warning';
    priority: 'low' | 'medium' | 'high';
    title: string;                // Catchy title
    content: string;              // Detailed description
    actionable?: string;          // Recommended action
    icon: string;                 // Suggested icon
    color: string;                // Hex color
  }>;
  dataQuality: 'excellent' | 'good' | 'limited' | 'insufficient';
  analysisDate: string;           // Analysis timestamp
  periodDays: number;             // Analyzed period
  aiModel: string;                // Used model (gpt-5-mini)
  tokensUsed: number;             // Consumed tokens
  cached: boolean;                // If result cached
}
```

**Generated Insight Example:**
```json
{
  "id": "fasting_pattern_001",
  "type": "pattern",
  "priority": "medium",
  "title": "You fast better on weekends",
  "content": "Your weekend sessions last an average of 2h longer than weekday ones. This suggests less stress and more control over your environment.",
  "actionable": "Prepare your weekday meals in advance to reduce temptations and maintain your fasting schedule.",
  "icon": "Calendar",
  "color": "#F59E0B"
}
```

### Progression Data (`fasting-progression-analyzer`)

**Response Structure:**
```typescript
interface FastingProgressionResponse {
  metrics: FastingProgressionMetrics;  // Calculated metrics
  aiAnalysis: {
    narrativeSummary: string;          // Narrative progression summary
    trendAnalysis: string;             // Trend analysis
    performanceInsights: string[];     // Performance insights (3-5)
    strategicRecommendations: string[]; // Strategic recommendations (3-4)
    motivationalMessage: string;       // Personalized motivational message
    nextMilestone: string;             // Suggested next goal
  };
  dataQuality: 'excellent' | 'good' | 'limited' | 'insufficient';
  analysisDate: string;               // Analysis timestamp
  periodDays: number;                 // Analyzed period
  aiModel: string;                    // Used model
  tokensUsed: number;                 // Consumed tokens
  cached: boolean;                    // If result cached
}
```

**Progression Analysis Example (based on your logs):**
```json
{
  "narrativeSummary": "Over the last 7 days you have shown excellent adherence: 7 planned sessions and 7 completed sessions, for a total fasted time of 110.9h (average 15.8h/day). Your preferred goal is the 16:8 protocol and you are very close to the target ‚Äî personal record 16.5h shows you can exceed the threshold.",
  "trendAnalysis": "Overall trend: stable/positive but perfectible. You maintain perfect daily adherence (100%) and a fasting average that approaches the 16h goal (only ~12 minutes below).",
  "performanceInsights": [
    "Strong adherence: 100% of completed sessions shows high discipline ‚Äî major asset for lasting progress.",
    "Close to 16:8 protocol: average 15.8h/day means you are ~12 minutes from the goal; small schedule adjustments could be enough to regularly reach 16h."
  ],
  "strategicRecommendations": [
    "Adjust the 16:8 window to fit your morning chronotype: move it earlier (e.g. 07:00‚Äì15:00 or 08:00‚Äì16:00).",
    "Stabilize schedule: choose a fixed start/end window time and aim to increase fasting average to ‚â•16h."
  ],
  "motivationalMessage": "You have laid an excellent foundation: perfect discipline this week and you practically touch your 16:8 goal. With a few simple adjustments, you will transform this consistency into visible gains.",
  "nextMilestone": "Achieve a 14-day streak with average ‚â•16h/day"
}
```

---

## üìã TypeScript Contracts

### Main Interfaces

```typescript
// Fasting session
export interface FastingSession {
  id?: string;
  userId: string;
  startTime: Date;
  endTime?: Date;
  targetHours: number;
  actualDurationHours?: number;
  protocol: string;
  status: 'active' | 'completed' | 'cancelled';
  notes?: string;
}

// Pipeline state
export interface FastingPipelineState {
  currentStep: 'setup' | 'active' | 'completion';
  isActive: boolean;
  session: FastingSession | null;
  steps: FastingStepData[];
  lastTick: number;
}

// Fasting insight
export interface FastingInsight {
  id: string;
  type: 'pattern' | 'recommendation' | 'achievement' | 'warning';
  priority: 'low' | 'medium' | 'high';
  title: string;
  content: string;
  actionable?: string;
  icon: string;
  color: string;
}

// Insights summary
export interface FastingInsightsSummary {
  overallScore: number;
  keyFindings: string[];
  mainRecommendation: string;
  sentiment: 'positive' | 'neutral' | 'encouraging';
}

// Progression metrics
export interface FastingProgressionMetrics {
  totalSessions: number;
  totalFastedHours: number;
  averageDuration: number;
  longestFast: number;
  bestStreak: number;
  currentStreak: number;
  successRate: number;
  consistencyScore: number;
}

// AI progression analysis
export interface FastingProgressionAnalysis {
  narrativeSummary: string;
  trendAnalysis: string;
  performanceInsights: string[];
  strategicRecommendations: string[];
  motivationalMessage: string;
  nextMilestone: string;
}

// Consistency data for visualizations
export interface FastingConsistencyData {
  date: string;
  hasFasted: boolean;
  totalHours: number;
  sessionsCount: number;
  averageDuration: number;
  outcome: 'success' | 'partial' | 'missed' | 'none';
}

// History filters
export interface FastingHistoryFilters {
  status?: 'all' | 'completed' | 'cancelled';
  protocol?: string;
  dateRange?: {
    start: Date;
    end: Date;
  };
  minDuration?: number;
  maxDuration?: number;
}

// Metabolic phase
export interface FastingPhase {
  id: string;
  name: string;
  description: string;
  durationRange: [number, number];
  benefits: string[];
  color: string;
  icon: keyof typeof ICONS;
  caloriesBurnRate: 'low' | 'medium' | 'high' | 'very_high';
  metabolicState: string;
}
```

---

## üéØ Optimizations and Performance

### Frontend
- **React Query:** Intelligent cache with adaptive `staleTime` (5min for today, 10min for insights)
- **Zustand Persistence:** Pipeline survives reloads with localStorage
- **Optimized Timer:** Global interval with `useFastingElapsedSeconds()` and `useFastingProgressPercentage()`
- **Framer Motion:** Conditional animations (`prefers-reduced-motion`)
- **Audio System:** "Strike & Bloom" with fasting-specific feedback

### Backend
- **Server cache:** `ai_analysis_jobs` table with `input_hash` for deduplication
- **Rate limiting:** Protection against excessive calls with debouncing
- **Retry logic:** Temporary OpenAI error handling
- **Cost tracking:** Precise audit of tokens and costs per analysis

### Database
- **RLS:** Row-level security on `fasting_sessions`
- **Indexes:** Optimized for queries by `user_id` and `timestamp`
- **Triggers:** Automatic `updated_at`
- **Constraints:** Duration and status validation

### Fasting-Specific Optimizations
- **Global timer:** Single interval for all active sessions
- **Dynamic selectors:** Real-time calculations without excessive re-renders
- **Phase cache:** Cached metabolic calculations
- **Lazy loading:** Heavy components loaded on demand

---

## üí∞ Costs and Governance

### Costs per Component (based on your logs)

**Insights Analysis:**
- **Model:** GPT-5 Mini
- **Average tokens:** ~2659 tokens
- **Unit cost:** ~$0.00076 USD
- **Duration:** ~15-45 seconds

**Progression Analysis:**
- **Model:** GPT-5 Mini
- **Average tokens:** ~2683 tokens
- **Unit cost:** ~$0.00076 USD
- **Duration:** ~20-60 seconds

### Monthly Estimates per User

| Fasting Scenario | AI Analyses/month | Estimated cost |
|------------------|-------------------|----------------|
| Occasional       | 2                 | ~$0.002        |
| Regular          | 4                 | ~$0.004        |
| Intensive        | 8                 | ~$0.008        |

### Cost Optimizations

**Intelligent Cache:**
- **Validity:** 24h to avoid unnecessary regenerations
- **Hit rate:** ~40% after adoption (significant savings)
- **Invalidation:** Based on new data thresholds

**Adaptive Thresholds:**
- **Insufficient data:** No AI call, encouragement message
- **Incomplete profile:** Completeness alert before analysis
- **Minimum sessions:** Different thresholds by analysis period

**Graceful Fallback:**
- **AI error:** Basic data calculated locally
- **Timeout:** Degraded interface with basic data
- **Quota exceeded:** Degraded mode with static advice

### Governance

**Cost Monitoring:**
- **Audit table:** `ai_analysis_jobs` with precise tracking
- **Structured logs:** `FASTING_*_COST_AUDIT` with details
- **Alerts:** Predefined threshold overruns

**User Quotas:**
- **Analyses per day:** Maximum 5 per user
- **Analyses per month:** Maximum 50 per user
- **Protection:** Rate limiting with explanatory messages

---

## üîç Observability and Debugging

### Structured Logs

**Insights log example (based on your logs):**
```typescript
{
  level: 'info',
  message: 'FASTING_INSIGHTS_COST_AUDIT AI generation cost calculated',
  context: {
    userId: '53b79d4b-0c23-4c19-8fb4-08466b457f5a',
    analysisType: 'fasting_insights',
    periodDays: 7,
    tokensUsed: 2659,
    estimatedCostUSD: 0.00076,
    model: 'gpt-5-mini',
    cached: false,
    philosophy: 'ai_cost_transparency_audit'
  },
  timestamp: '2025-09-24T15:27:31.430Z'
}
```

**Progression log example:**
```typescript
{
  level: 'info',
  message: 'FASTING_PROGRESSION_ANALYZER AI progression analysis generated successfully',
  context: {
    userId: '53b79d4b-0c23-4c19-8fb4-08466b457f5a',
    periodDays: 7,
    tokensUsed: 2683,
    consistencyScore: 71,
    overallScore: 82,
    insightsCount: 5,
    cached: false
  },
  timestamp: '2025-09-24T16:21:13.021Z'
}
```

### Key Metrics
- **E2E SLO:** < 60 seconds (AI generation + cache + display)
- **Success rate:** > 95% for each Edge Function
- **Cache hit rate:** > 40% for cost optimization
- **Average confidence:** > 85% for AI analyses

### Debugging

**Tracing Identifiers:**
- **clientScanId:** End-to-end session tracking
- **inputHash:** Analysis deduplication and cache
- **userId:** User data isolation

**Fallback Strategies:**
- **AI error:** Locally calculated metrics
- **Timeout:** Degraded interface with basic data
- **Insufficient data:** Contextual encouragement messages

---

## üß† Future Integration with Central Brain

### Exportable Data

**Behavioral Metrics:**
- **Temporal discipline:** `consistencyScore`, schedule patterns
- **Metabolic preferences:** Effective protocols, optimal durations
- **Performance:** Streak evolution, success rate, progression

**Actionable Insights:**
- **Recommendations:** Suggested actions with priorities and context
- **Achievements:** Strengths to maintain or amplify
- **Patterns:** Detected habits for global optimization
- **Milestones:** Personalized next goals

**Metabolic Context Data:**
- **Preferred phases:** Which phases user reaches most often
- **Metabolic efficiency:** Correlation between duration and benefits
- **Success factors:** Optimal conditions for successful fasting

### Future Correlations

**With Energy Forge:**
- Training performance according to fasting state
- Optimization of activity slots vs fasting windows
- Calories burned during fasting vs physical activity

**With Nutritional Forge:**
- Nutritional quality vs fasting performance
- Meal timing vs fasting ease
- Macronutrients vs metabolic phases reached

**With TwinVision:**
- Body composition evolution vs fasting consistency
- Fasting efficiency according to morphology
- Protocol adaptation according to body measurements

**With Emotional Data:**
- Correlation between stress and fasting capacity
- Chronotype impact on performance
- Sleep quality vs fasting ease

### Central Brain Architecture

**Data Sources:**
```typescript
interface CentralBrainInput {
  // Time Forge
  fastingMetrics: FastingProgressionMetrics;
  fastingInsights: FastingInsight[];
  fastingPatterns: FastingConsistencyData[];
  fastingPhases: FastingPhaseData[];
  
  // Energy Forge
  activitySummary: ActivitySummary;
  activityInsights: ActivityInsight[];
  
  // Nutritional Forge
  nutritionSummary: NutritionSummary;
  mealInsights: MealInsight[];
  
  // TwinVision
  morphologyData: MorphologyData;
  bodyComposition: BodyComposition;
  
  // User Profile
  userProfile: UserProfile;
  userGoals: UserGoals;
}
```

**Expected Output:**
```typescript
interface HolisticFastingRecommendations {
  globalWellnessScore: number;           // Global wellness score
  fastingOptimizations: FastingOptimization[]; // Specific optimizations
  crossForgeInsights: CrossForgeInsight[];     // Cross-forge insights
  weeklyFastingPlan: WeeklyFastingPlan;        // Optimized weekly plan
  longTermFastingStrategy: LongTermStrategy;   // Long-term strategy
  metabolicRecommendations: MetabolicAdvice[]; // Metabolic advice
}
```

### Future Correlation Examples

**Fasting + Activity:**
```typescript
// Example: Training slot optimization
if (fastingPhase === 'fat_burning' && activityLevel === 'high') {
  recommendation = "Schedule your cardio workouts during the fat burning phase (12-18h of fasting) to maximize lipolysis.";
}
```

**Fasting + Nutrition:**
```typescript
// Example: Fast-breaking optimization
if (fastingDuration >= 16 && nextMeal === 'first') {
  recommendation = "Break your fast with 25-30g of protein and complex carbs to optimize metabolic recovery.";
}
```

**Fasting + Morphology:**
```typescript
// Example: Adaptation according to body composition
if (bodyFatPercentage > 20 && fastingConsistency > 80) {
  recommendation = "Your excellent fasting consistency should accelerate fat loss. Consider extending to 18:6 to optimize lipolysis.";
}
```

---

## üîß Maintenance and Evolution

### Extension Points

**New Protocols:**
- **ADF (Alternate Day Fasting):** Fast every other day
- **5:2:** 5 normal days, 2 calorie restriction days
- **Eat-Stop-Eat:** 24h fasts once or twice per week

**Spatial Forge Models:**
- **Migration to GPT-5:** More sophisticated analyses
- **Specialized models:** AI dedicated to metabolism and fasting
- **Multimodality:** Integration of biometric data

**Custom Metrics:**
- **Biomarkers:** Integration of glucose, ketone data
- **Wearables:** Heart rate data, HRV variability
- **Sleep:** Correlation with sleep quality

### Continuous Monitoring

**Performance:**
- **SLOs:** Edge Function response time monitoring
- **Availability:** AI analysis uptime
- **Latency:** Insight generation time

**Costs:**
- **Continuous optimization:** Token reduction via prompt engineering
- **Daily monitoring:** Budget overrun alerts
- **ROI:** Added value vs cost measurement

**Quality:**
- **User feedback:** Insight and recommendation relevance
- **Accuracy:** Metabolic estimation validation
- **Satisfaction:** Time Forge-specific NPS

### Planned Evolutions

**Q1 2025:**
- **Wearables integration:** Apple Health, Google Fit
- **Smart notifications:** Adaptive reminders
- **Advanced protocols:** ADF, 5:2, Eat-Stop-Eat

**Q2 2025:**
- **Central Brain:** Integration with other forges
- **Biomarkers:** Glucose and ketone support
- **Social features:** Challenges and community

**Q3 2025:**
- **Specialized AI:** Metabolism-dedicated models
- **Predictions:** Difficulty anticipation
- **Advanced coaching:** Dynamic protocol adaptation

---

## üìû Support and Contribution

For any technical questions or improvement suggestions regarding the Time Forge, consult this document or contact the development team.

**Key files to consult:**
- **Pipeline:** `src/app/pages/Fasting/FastingInputPage.tsx`
- **Data hooks:** `src/app/pages/Fasting/hooks/useFastingPipeline.ts`
- **Insights hooks:** `src/app/pages/Fasting/hooks/useFastingInsightsGenerator.ts`
- **Progression hooks:** `src/app/pages/Fasting/hooks/useFastingProgressionData.ts`
- **Repository:** `src/system/data/mockFastingSessions.ts`
- **Edge Functions:** `supabase/functions/fasting-*`
- **Metabolic phases:** `src/lib/nutrition/fastingPhases.ts`
- **Protocols:** `src/lib/nutrition/fastingProtocols.ts`
- **Utilities:** `src/app/pages/Fasting/utils/fastingUtils.ts`

**Component Structure:**
- **Stages:** `src/app/pages/Fasting/components/Stages/`
- **Tabs:** `src/app/pages/Fasting/components/Tabs/`
- **Cards:** `src/app/pages/Fasting/components/Cards/`
- **Shared:** `src/app/pages/Fasting/components/Shared/`
- **Insights:** `src/app/pages/Fasting/components/Insights/`
- **Progression:** `src/app/pages/Fasting/components/Progression/`
- **History:** `src/app/pages/Fasting/components/History/`

---

*This documentation is maintained up-to-date with each Time Forge evolution. Last revision: January 2025*