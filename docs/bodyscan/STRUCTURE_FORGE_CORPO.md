# TwinForge â€” Body Forge Project Structure

**Version:** 1.0 â€¢ **Status:** Functional â€¢ **Last Update:** January 2025

Complete documentation of the file and folder organization for the **Body Forge** (3D avatar generation and morphological analysis system) of TwinForge.

---

## ğŸ“‹ Table of Contents

- [Body Forge Overview](#body-forge-overview)
- [Feature Architecture](#feature-architecture)
- [Page Structure](#page-structure)
- [Components by Category](#components-by-category)
- [Hooks and Business Logic](#hooks-and-business-logic)
- [Utilities and Helpers](#utilities-and-helpers)
- [Edge Functions](#edge-functions)
- [Profile Integration](#profile-integration)
- [Configuration Files](#configuration-files)
- [Database](#database)

---

## ğŸ¯ Body Forge Overview

The **Body Forge** is TwinForge's advanced 3D avatar generation and morphological analysis system, transforming 2 photos into personalized 3D avatars with comprehensive morphological insights through AI-powered analysis.

### Objectives
- **3D Avatar Generation** from 2 photos (front + profile) with realistic morphology
- **Morphological Analysis** using advanced AI algorithms and archetype matching
- **Personalized Insights** generated by GPT-5 Mini with morphological expertise
- **Real-time 3D Visualization** with interactive avatar viewer
- **Historical Tracking** of body composition changes over time

### Role in TwinForge Ecosystem
- **Core Identity System**: Provides visual representation for all health modules
- **Morphological Foundation**: Enables personalized nutrition and fitness recommendations
- **Progress Tracking**: Visual comparison of body changes over time
- **Motivation Engine**: Gamified avatar evolution based on health goals

---

## ğŸ—ï¸ Feature Architecture

### Tech Stack
- **Frontend:** React 18 + TypeScript + Three.js + Framer Motion
- **State Management:** Zustand (scan pipeline) + React Query (network cache)
- **Backend:** Supabase Edge Functions (Deno) + PostgreSQL
- **Spatial Forge:** OpenAI GPT-4o Vision + GPT-5 Mini for analysis
- **3D Rendering:** Three.js + WebGL with optimized materials and lighting
- **Database:** PostgreSQL with RLS, triggers, and vector embeddings

### Data Flow
```
User (2 Photos: Front + Profile)
    â†“
Frontend (Photo Capture + Validation)
    â†“
Edge Function: scan-estimate (GPT-4o Vision + Measurements)
    â†“
Edge Function: scan-semantic (GPT-5 Mini + Classification)
    â†“
Edge Function: scan-match (Archetype Selection + K=5 Envelope)
    â†“
Edge Function: scan-refine-morphs (GPT-4o + Morphological Refinement)
    â†“
Edge Function: scan-commit (3D Avatar Generation + Profile Update)
    â†“
Edge Function: generate-morph-insights (GPT-5 Mini + Personalized Analysis)
    â†“
Frontend (3D Avatar Viewer + Insights Dashboard)
```

---

## ğŸ“ Page Structure

### Main Pages
```
src/app/pages/
â”œâ”€ Avatar/
â”‚  â””â”€ AvatarPage.tsx            # Main avatar page with 4 tabs (Scan CTA, Avatar, Insights, History)
â”œâ”€ BodyScan.tsx                 # Body scan orchestrator page
â”œâ”€ BodyScan/
â”‚  â”œâ”€ BodyScanCapture.tsx       # Photo capture pipeline
â”‚  â”œâ”€ BodyScanReview.tsx        # Scan results review and avatar generation
â”‚  â””â”€ BodyScanCelebrationStep.tsx # Success celebration with avatar reveal
â”œâ”€ FaceScanPage.tsx             # Face scan main page
â””â”€ FaceScan/
   â”œâ”€ FaceScanPhotoCaptureStep.tsx # Face photo capture
   â”œâ”€ FaceScanReviewPage.tsx    # Face scan review
   â””â”€ FaceScanCelebrationStep.tsx # Face scan completion
```

---

## ğŸ§© Components by Category

### ğŸ“ Complete Component Structure
```
src/app/pages/Avatar/tabs/
â”œâ”€ ScanCTA.tsx                  # Call-to-action for new scans
â”œâ”€ AvatarTab.tsx                # 3D avatar viewer and controls
â”œâ”€ InsightsTab.tsx              # Morphological insights dashboard
â””â”€ HistoryTab.tsx               # Historical scans and comparisons

src/app/pages/BodyScan/
â”œâ”€ BodyScanCapture/
â”‚  â”œâ”€ BodyScanCapture.tsx       # Main capture orchestrator
â”‚  â”œâ”€ BodyScanPhotoCaptureStep.tsx # Photo capture step
â”‚  â”œâ”€ components/
â”‚  â”‚  â”œâ”€ PhotoCard.tsx          # Individual photo display
â”‚  â”‚  â”œâ”€ PhotoCaptureControls.tsx # Capture controls
â”‚  â”‚  â”œâ”€ PhotoCaptureStatus.tsx # Capture status indicator
â”‚  â”‚  â”œâ”€ CapturedPhotoDisplay.tsx # Captured photo preview
â”‚  â”‚  â”œâ”€ ImmersivePhotoAnalysis.tsx # AI analysis visualization
â”‚  â”‚  â””â”€ ReadyForProcessingCard.tsx # Processing readiness indicator
â”‚  â”œâ”€ hooks/
â”‚  â”‚  â””â”€ useBodyScanCaptureFlow.ts # Capture flow state management
â”‚  â”œâ”€ services/
â”‚  â”‚  â””â”€ scanProcessingService.ts # Scan processing logic
â”‚  â””â”€ utils/
â”‚     â”œâ”€ dataExtractors.ts      # Data extraction utilities
â”‚     â””â”€ insightGenerator.ts    # Insight generation helpers
â”œâ”€ BodyScanReview/
â”‚  â”œâ”€ BodyScanReview.tsx        # Main review orchestrator
â”‚  â”œâ”€ components/
â”‚  â”‚  â”œâ”€ ActionButtons.tsx      # Review action buttons
â”‚  â”‚  â”œâ”€ MeasurementsCard.tsx   # Measurements display
â”‚  â”‚  â””â”€ MorphAdjustmentControls.tsx # Morph adjustment interface
â”‚  â”œâ”€ hooks/
â”‚  â”‚  â””â”€ useReviewState.ts      # Review state management
â”‚  â””â”€ utils/
â”‚     â””â”€ avatarActions.ts       # Avatar generation actions
â”œâ”€ components/
â”‚  â”œâ”€ CameraInterface/
â”‚  â”‚  â”œâ”€ CameraInterface.tsx    # Camera interface wrapper
â”‚  â”‚  â”œâ”€ CameraControls.tsx     # Camera control buttons
â”‚  â”‚  â””â”€ CameraOverlayGuides.tsx # Photo guidance overlays
â”‚  â””â”€ PhotoGuideOverlay.tsx     # Photo positioning guides
â””â”€ constants.ts                 # Body scan constants

src/components/3d/Avatar3DViewer/
â”œâ”€ Avatar3DViewer.tsx           # Main 3D viewer component
â”œâ”€ core/
â”‚  â”œâ”€ modelLoader.ts            # 3D model loading
â”‚  â”œâ”€ morphApplier.ts           # Morphological transformations
â”‚  â”œâ”€ sceneManager.ts           # Three.js scene management
â”‚  â””â”€ materialConfigurator.ts   # Material and texture configuration
â”œâ”€ components/
â”‚  â”œâ”€ DebugInfo.tsx             # Debug information overlay
â”‚  â”œâ”€ ErrorOverlay.tsx          # Error state display
â”‚  â”œâ”€ LoadingOverlay.tsx        # Loading state animation
â”‚  â””â”€ ViewerControls.tsx        # 3D viewer controls
â”œâ”€ hooks/
â”‚  â”œâ”€ useModelLifecycle.ts      # Model loading lifecycle
â”‚  â”œâ”€ useMorphLifecycle.ts      # Morphology application lifecycle
â”‚  â”œâ”€ useMaterialLifecycle.ts   # Material configuration lifecycle
â”‚  â”œâ”€ useSceneLifecycle.ts      # Scene management lifecycle
â”‚  â””â”€ useAvatarViewerOrchestrator.ts # Main orchestrator hook
â””â”€ utils/
   â”œâ”€ viewerTypes.ts            # TypeScript definitions
   â””â”€ payloadProcessor.ts       # Payload processing utilities
```

### ğŸ“ Category Descriptions

**Avatar Tabs:** Main tabs of AvatarPage
- `ScanCTA`: Dynamic call-to-action for initiating new body scans
- `AvatarTab`: Interactive 3D avatar viewer with morphology controls
- `InsightsTab`: AI-generated morphological insights and recommendations
- `HistoryTab`: Historical scan comparison and progress tracking

**Body Scan Pipeline:** Complete scan processing workflow
- `BodyScanCapture`: Photo capture with real-time validation
- `BodyScanReview`: Results review and avatar generation
- `BodyScanCelebration`: Success celebration with avatar reveal

**3D Avatar System:** Advanced 3D rendering and interaction
- `Avatar3DViewer`: Main 3D viewer with Three.js integration
- `ModelLoader`: Optimized 3D model loading and caching
- `MorphApplier`: Real-time morphological transformations
- `MaterialConfigurator`: PBR material and texture management

**Camera Interface:** Photo capture system
- `CameraInterface`: WebRTC camera integration
- `CameraControls`: Capture controls and settings
- `PhotoGuideOverlay`: Visual guidance for optimal photo positioning

**Insights System:** AI-powered analysis and recommendations
- `InsightsTab`: Comprehensive morphological analysis dashboard
- `InsightCard`: Individual insight cards with actionable recommendations
- `SummaryDashboard`: Overview of morphological metrics and trends

---

## ğŸ£ Hooks and Business Logic

### ğŸ“ Specialized Hooks
```
src/app/pages/BodyScan/BodyScanCapture/hooks/
â””â”€ useBodyScanCaptureFlow.ts    # Capture flow state management

src/app/pages/BodyScan/BodyScanReview/hooks/
â””â”€ useReviewState.ts            # Review state and avatar generation

src/app/pages/Profile/hooks/
â””â”€ useProfileAvatarData.ts      # Profile avatar data integration

src/components/3d/Avatar3DViewer/hooks/
â”œâ”€ useModelLifecycle.ts         # 3D model loading and management
â”œâ”€ useMorphLifecycle.ts         # Morphology application and updates
â”œâ”€ useMaterialLifecycle.ts      # Material and texture lifecycle
â”œâ”€ useSceneLifecycle.ts         # Three.js scene management
â””â”€ useAvatarViewerOrchestrator.ts # Main 3D viewer orchestration

src/app/pages/Avatar/tabs/insights/
â””â”€ insightsService.ts           # AI insights generation and caching
```

### ğŸ“ Hook Responsibilities

**`useBodyScanCaptureFlow`** - Photo capture orchestration
- **Multi-step pipeline**: Setup â†’ Front Photo â†’ Profile Photo â†’ Processing
- **Real-time validation**: Photo quality, pose detection, lighting analysis
- **Error handling**: Retry mechanisms and user guidance
- **State persistence**: Survives navigation and page reloads

**`useReviewState`** - Scan results and avatar generation
- **Results processing**: Measurements, morphology, and avatar data
- **Avatar generation**: 3D model creation and optimization
- **User feedback**: Rating and adjustment capabilities
- **Profile integration**: Automatic profile updates with scan data

**`useProfileAvatarData`** - Profile avatar integration
- **Avatar synchronization**: Profile â†” Avatar data consistency
- **Historical tracking**: Avatar evolution over time
- **Preference management**: Avatar display and privacy settings
- **Data validation**: Ensures avatar data integrity

**`useAvatarViewerOrchestrator`** - 3D viewer orchestration
- **Scene management**: Three.js scene setup and optimization
- **Model lifecycle**: Loading, morphing, and disposal
- **Performance optimization**: LOD, culling, and memory management
- **User interaction**: Camera controls, morphology adjustments

**`insightsService`** - AI insights generation
- **Intelligent caching**: Avoids redundant AI calls (input hash-based)
- **Morphological analysis**: Body composition and shape analysis
- **Personalized recommendations**: Goal-based advice and action items
- **Progress tracking**: Comparative analysis with historical data

---

## ğŸ› ï¸ Utilities and Helpers

### ğŸ“ Body Forge Utilities
```
src/lib/utils/
â””â”€ photoUtils.ts                # Photo processing and validation

src/lib/morph/
â”œâ”€ blend.ts                     # Morphological blending algorithms
â”œâ”€ constraints.ts               # Morphological constraints and validation
â”œâ”€ preparePayload.ts            # Payload preparation for Edge Functions
â””â”€ payload/
   â”œâ”€ payloadBuilder.ts         # Structured payload construction
   â”œâ”€ payloadClamping.ts        # Value clamping and validation
   â”œâ”€ payloadConverters.ts      # Data format conversions
   â””â”€ payloadValidators.ts      # Payload validation logic

src/lib/3d/
â”œâ”€ setup/
â”‚  â””â”€ lightingSetup.ts          # Three.js lighting configuration
â”œâ”€ materials/
â”‚  â”œâ”€ applySkinTone.ts          # Skin tone application
â”‚  â””â”€ materialConfigurator.ts   # PBR material setup
â”œâ”€ bones/
â”‚  â”œâ”€ boneMapping.ts            # Bone hierarchy mapping
â”‚  â”œâ”€ applyLimbMassToBones.ts   # Limb mass to bone transformations
â”‚  â””â”€ core/
â”‚     â”œâ”€ boneScaling.ts         # Bone scaling algorithms
â”‚     â”œâ”€ boneDiscovery.ts       # Bone structure discovery
â”‚     â””â”€ interplayEvaluator.ts  # Bone interaction evaluation
â””â”€ camera/
   â””â”€ OrbitTouchControls.ts     # Touch-optimized camera controls

src/lib/scan/
â”œâ”€ normalizeSkinTone.ts         # Skin tone normalization
â””â”€ normalizeLimbMasses.ts       # Limb mass normalization

src/lib/image/
â””â”€ skinToneExtractor.ts         # Advanced skin tone extraction
```

### ğŸ“ Key Utility Functions

**`photoUtils.ts`** - Photo processing and validation
- `validatePhotoQuality()`: Blur, brightness, and exposure analysis
- `detectPoseCompliance()`: Pose validation against requirements
- `extractPhotoMetadata()`: EXIF data extraction and analysis
- `optimizePhotoForUpload()`: Compression and format optimization

**`blend.ts`** - Morphological blending
- `blendMorphTargets()`: Weighted morphological target blending
- `interpolateLimbMasses()`: Smooth limb mass interpolation
- `validateMorphBounds()`: Morphological constraint validation
- `optimizeBlendWeights()`: Performance-optimized blending

**`payloadBuilder.ts`** - Structured data construction
- `buildScanEstimatePayload()`: Payload for scan estimation
- `buildSemanticAnalysisPayload()`: Payload for semantic analysis
- `buildMorphRefinementPayload()`: Payload for morphological refinement
- `validatePayloadIntegrity()`: Comprehensive payload validation

**`materialConfigurator.ts`** - 3D material management
- `configurePBRMaterials()`: Physically-based rendering setup
- `applySkinToneToMaterial()`: Dynamic skin tone application
- `optimizeMaterialPerformance()`: Performance optimization
- `updateMaterialProperties()`: Real-time material updates

**`boneMapping.ts`** - Skeletal system management
- `mapLimbMassesToBones()`: Limb mass to bone transformations
- `validateBoneHierarchy()`: Skeletal structure validation
- `optimizeBoneTransforms()`: Performance-optimized transformations
- `calculateBoneInfluences()`: Bone influence calculations

---

## âš¡ Edge Functions

### ğŸ“ Serverless Functions
```
supabase/functions/
â”œâ”€ scan-estimate/               # Stage 1: Photo analysis and measurements
â”‚  â””â”€ index.ts                  # GPT-4o Vision + measurement extraction
â”œâ”€ scan-semantic/               # Stage 2: Semantic classification
â”‚  â””â”€ index.ts                  # GPT-5 Mini + morphological classification
â”œâ”€ scan-match/                  # Stage 3: Archetype matching
â”‚  â””â”€ index.ts                  # GPT-5 Mini + K=5 envelope selection
â”œâ”€ scan-refine-morphs/          # Stage 4: AI morphological refinement
â”‚  â””â”€ index.ts                  # GPT-4o + precise morphological adjustments
â”œâ”€ scan-commit/                 # Stage 5: Avatar generation and storage
â”‚  â””â”€ index.ts                  # 3D processing + profile updates
â”œâ”€ generate-morph-insights/     # Stage 6: Personalized insights
â”‚  â””â”€ index.ts                  # GPT-5 Mini + morphological expertise
â”œâ”€ face-estimate/               # Face scan: Photo analysis
â”‚  â””â”€ index.ts                  # GPT-4o Vision + facial measurements
â”œâ”€ face-semantic/               # Face scan: Semantic classification
â”‚  â””â”€ index.ts                  # GPT-5 Mini + facial feature classification
â”œâ”€ face-match/                  # Face scan: Archetype matching
â”‚  â””â”€ index.ts                  # Vector similarity + archetype selection
â”œâ”€ face-refine-morphs/          # Face scan: AI refinement
â”‚  â””â”€ index.ts                  # GPT-4o + facial morphological refinement
â””â”€ face-commit/                 # Face scan: Face avatar generation
   â””â”€ index.ts                  # 3D face processing + profile updates
```

### ğŸ“ Edge Function Specialties

**`scan-estimate`** - Photo analysis and measurements
- **Model**: GPT-4o Vision optimized for body measurement extraction
- **Specialties**: Anthropometric measurements, pose analysis, photo quality
- **Average cost**: ~$0.0015 - $0.008 per scan (varies by photo complexity)
- **Duration**: ~15-30 seconds
- **Output**: Raw measurements, keypoints, skin tone, quality metrics

**`scan-semantic`** - Morphological classification
- **Model**: GPT-5 Mini optimized for body shape classification
- **Specialties**: Body type classification, muscularity assessment, adiposity analysis
- **Average cost**: ~$0.002 - $0.012 per analysis
- **Duration**: ~10-25 seconds
- **Output**: Semantic profile (obesity, muscularity, level, morphotype)

**`scan-match`** - Archetype selection and envelope generation
- **Model**: GPT-5 Mini + database archetype matching algorithms
- **Specialties**: K=5 archetype selection, morphological envelope generation
- **Average cost**: ~$0.001 - $0.005 per matching (mostly algorithmic)
- **Duration**: ~5-15 seconds
- **Output**: Selected archetypes, blended morphology, limb masses

**`scan-refine-morphs`** - AI morphological refinement
- **Model**: GPT-4o optimized for morphological precision
- **Specialties**: Fine-tuned morphological adjustments, constraint validation
- **Average cost**: ~$0.015 - $0.025 per refinement (highest cost due to complexity)
- **Duration**: ~20-45 seconds
- **Output**: Refined morphology, validated parameters, confidence scores

**`scan-commit`** - Avatar generation and storage
- **Model**: Processing-only (no AI model)
- **Specialties**: 3D avatar generation, profile updates, data persistence
- **Average cost**: ~$0.001 - $0.005 per commit (computational only)
- **Duration**: ~10-20 seconds
- **Output**: 3D avatar data, updated profile, scan history

**`generate-morph-insights`** - Personalized morphological insights
- **Model**: GPT-5 Mini with morphological expertise
- **Specialties**: Body composition analysis, personalized recommendations
- **Average cost**: ~$0.0025 - $0.015 per insight generation
- **Duration**: ~15-35 seconds
- **Output**: Morphological insights, recommendations, progress analysis

---

## ğŸ‘¤ Profile Integration

### ğŸ“ Integration Files
```
src/app/pages/Profile/ProfileAvatarTab.tsx     # Avatar configuration in profile
src/app/pages/Profile/ProfileHealthTab.tsx    # Health metrics integration
src/system/store/userStore.ts                 # Profile data synchronization
src/system/store/profileRepository.ts         # Profile data persistence
```

### ğŸ“ Profile Fields Used

**Critical Fields (Required for Body Forge):**
- `sex`: Gender-specific morphological constraints and archetype selection
- `height_cm`: Scale calibration and anthropometric validation
- `weight_kg`: BMI calculation and morphological consistency checks
- `birthdate`: Age-based morphological adjustments and recommendations
- `objective`: Goal-oriented avatar evolution and insight personalization

**Avatar Configuration:**
- `avatar_status`: Current avatar generation status (none, pending, ready, error)
- `avatar_url`: Generated 3D avatar model URL
- `avatar_generation_stage`: Current generation stage tracking
- `avatar_onboarding_completed`: First-time setup completion status
- `active_face_profile_id`: Active face profile for combined body+face avatars

**Morphological Data:**
- `hip_mass`: Hip region morphological mass (0.5-2.5 range)
- `shoulder_mass`: Shoulder region morphological mass (0.5-2.5 range)
- `skin_tone`: RGB skin tone values extracted from photos
- `facial_keypoints`: Facial landmark data for face-body integration

**Optimizing Fields:**
- `body_fat_perc`: Body composition validation and insight generation
- `activity_level`: Morphological recommendations based on fitness level
- `target_weight_kg`: Goal-oriented avatar evolution tracking
- `health`: Medical conditions affecting morphological analysis

### ğŸ“ Scan Data Profile Updates

**Automatic Updates After Scan:**
- `avatar_status`: Updated to "ready" after successful generation
- `avatar_url`: Set to generated 3D model URL
- `skin_tone`: Updated with extracted skin tone from photos
- `hip_mass` & `shoulder_mass`: Updated with calculated limb masses
- `last_avatar_regeneration_at`: Timestamp of last avatar update

**Historical Tracking:**
- `avatar_regeneration_count_7_days`: Rate limiting for avatar regenerations
- Scan data stored in `body_scans` table with full morphological parameters
- Avatar evolution tracked through `user_avatars` table updates

---

## âš™ï¸ Configuration Files

### ğŸ“ Specific Configuration
```
src/config/featureFlags.ts     # Feature flags for Body Forge development
src/config/debugFlags.ts       # Debug flags for 3D rendering and AI
```

### ğŸ“ Available Feature Flags

**Body Forge Feature Flags:**
- `ENABLE_BODY_SCAN`: Enable/disable body scanning functionality
- `ENABLE_FACE_SCAN`: Enable/disable face scanning functionality
- `ENABLE_3D_AVATAR_VIEWER`: Enable/disable 3D avatar visualization
- `ENABLE_MORPHOLOGICAL_INSIGHTS`: Enable/disable AI insights generation
- `MOCK_SCAN_DATA`: Use mock data for development and testing

**Debug Flags:**
- `DEBUG_3D_RENDERING`: Enable Three.js debug information
- `DEBUG_MORPH_CALCULATIONS`: Log morphological calculations
- `DEBUG_AI_PAYLOADS`: Log Edge Function payloads and responses
- `BYPASS_PHOTO_VALIDATION`: Skip photo quality validation (development)
- `ENABLE_PERFORMANCE_MONITORING`: Track 3D rendering performance

---

## ğŸ¨ Styles and Animations

### ğŸ“ Body Forge Specific Styles
```
src/styles/
â”œâ”€ components/
â”‚  â”œâ”€ body-scan.css             # Body scan interface styles
â”‚  â”œâ”€ bodyscan/
â”‚  â”‚  â”œâ”€ _base.css              # Base body scan styles
â”‚  â”‚  â”œâ”€ _capture.css           # Photo capture interface
â”‚  â”‚  â”œâ”€ _review.css            # Scan review interface
â”‚  â”‚  â”œâ”€ _processing.css        # Processing animations
â”‚  â”‚  â”œâ”€ _celebration.css       # Success celebration effects
â”‚  â”‚  â””â”€ _utilities.css         # Body scan utility classes
â”‚  â”œâ”€ avatar/
â”‚  â”‚  â”œâ”€ _insights.css          # Avatar insights dashboard
â”‚  â”‚  â””â”€ _historical-scan-modal.css # Historical scan modal
â”‚  â””â”€ celebration-animations.css # Avatar reveal animations
â”œâ”€ glassV2/
â”‚  â””â”€ animations.css            # Glass morphism animations for 3D viewer
â””â”€ effects/
   â””â”€ motion.css                # 3D viewer motion effects
```

### ğŸ“ Body Forge Specific Animations
- **Avatar reveal**: Dramatic 3D avatar appearance with particle effects
- **Morphological transitions**: Smooth morphology changes during refinement
- **Photo capture feedback**: Real-time visual feedback during photo capture
- **Processing indicators**: AI processing visualization with progress indicators
- **3D viewer interactions**: Smooth camera movements and model rotations
- **Insight animations**: Staggered insight card appearances with morphological context

---

## ğŸ—„ï¸ Database

### ğŸ“ Main Tables
```
body_scans                      # User body scan data
â”œâ”€ id (uuid, PK)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ timestamp (timestamptz)
â”œâ”€ metrics (jsonb)              # Raw measurements and analysis
â”œâ”€ morph3d (jsonb)              # 3D morphological parameters
â”œâ”€ limb_masses (jsonb)          # Limb mass distributions
â”œâ”€ skin_tone (jsonb)            # Extracted skin tone data
â””â”€ created_at (timestamptz)

user_avatars                    # Current user avatar state
â”œâ”€ user_id (uuid, PK, FK â†’ users)
â”œâ”€ current_scan_id (uuid, FK â†’ body_scans)
â”œâ”€ morph3d (jsonb)              # Active morphological parameters
â”œâ”€ limb_masses (jsonb)          # Active limb mass distributions
â”œâ”€ skin_tone (jsonb)            # Active skin tone configuration
â””â”€ updated_at (timestamptz)

body_scan_history              # Historical scan analysis
â”œâ”€ id (uuid, PK)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ scan_id (uuid, FK â†’ body_scans)
â”œâ”€ metrics_snapshot (jsonb)     # Historical metrics snapshot
â”œâ”€ temporal_analysis (jsonb)    # Temporal change analysis
â”œâ”€ outlier_flags (jsonb)        # Outlier detection flags
â”œâ”€ ema_data (jsonb)             # Exponential moving averages
â””â”€ created_at (timestamptz)

ai_morphology_insights         # AI-generated morphological insights
â”œâ”€ id (uuid, PK)
â”œâ”€ scan_id (uuid, FK â†’ body_scans)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ generated_at (timestamptz)
â”œâ”€ insights_data (jsonb)        # Generated insights and recommendations
â”œâ”€ summary_data (jsonb)         # Summary metrics and scores
â”œâ”€ ai_model_used (text)         # AI model version used
â”œâ”€ ai_confidence (numeric)      # AI confidence score
â””â”€ input_hash (text, unique)    # Deduplication key

user_face_profiles             # Face scan profiles
â”œâ”€ id (uuid, PK)
â”œâ”€ user_id (uuid, FK â†’ users)
â”œâ”€ active (boolean)             # Active face profile flag
â”œâ”€ final_face_params (jsonb)    # Final facial parameters
â”œâ”€ archetype_mix (jsonb)        # Face archetype blend
â”œâ”€ skin_tone (jsonb)            # Facial skin tone
â”œâ”€ head_model_url (text)        # 3D head model URL
â”œâ”€ preview_url (text)           # Face preview image URL
â”œâ”€ resolved_gender (gender_enum) # Resolved gender from analysis
â””â”€ created_at (timestamptz)

face_archetypes                # Face archetype database
â”œâ”€ id (text, PK)
â”œâ”€ name (text)
â”œâ”€ gender (gender_enum)
â”œâ”€ face_shape (face_shape_enum)
â”œâ”€ eye_shape (eye_shape_enum)
â”œâ”€ nose_type (nose_type_enum)
â”œâ”€ lip_fullness (lip_fullness_enum)
â”œâ”€ face_values (jsonb)          # Facial morphological values
â”œâ”€ face_embedding (vector(256)) # Vector embedding for similarity
â””â”€ preview_path (text)

morph_archetypes               # Body archetype database
â”œâ”€ id (text, PK)
â”œâ”€ name (text)
â”œâ”€ gender (text)
â”œâ”€ bmi_range (numeric[])        # BMI range for archetype
â”œâ”€ morph_values (jsonb)         # Morphological parameter values
â”œâ”€ limb_masses (jsonb)          # Limb mass distributions
â”œâ”€ obesity (text)               # Obesity classification
â”œâ”€ muscularity (text)           # Muscularity classification
â”œâ”€ level (text)                 # Body composition level
â””â”€ morphotype (text)            # Morphological type classification
```

### ğŸ“ Security and Performance

**Row Level Security (RLS):**
- **Enabled** on all user-specific tables (`body_scans`, `user_avatars`, `ai_morphology_insights`)
- **User isolation**: Users can only access their own scan data and avatars
- **Service role bypass**: Edge Functions use service role for cross-user operations

**Optimized Indexes:**
- `body_scans`: Composite index on `(user_id, timestamp DESC)` for historical queries
- `ai_morphology_insights`: Unique index on `input_hash` for deduplication
- `face_archetypes`: Vector index on `face_embedding` for similarity search
- `morph_archetypes`: Composite indexes on gender, BMI range, and semantic categories

**Automatic Triggers:**
- `updated_at` triggers on all tables with timestamp columns
- Avatar regeneration rate limiting triggers
- Scan data validation triggers for morphological constraints

**Vector Operations:**
- **Face similarity**: Cosine similarity search on face embeddings
- **Archetype matching**: Vector-based archetype selection for face scans
- **Performance optimization**: IVFFlat indexes for fast vector queries

---

*This documentation is specific to the Body Forge. Consult other STRUCTURE_*.md files for other features. Last revision: January 2025*